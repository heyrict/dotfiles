# Transparent SOCKS proxy
# See: http://darkk.net.ru/redsocks/

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:REDSOCKS - [0:0]

# Redirect all output through redsocks
-A OUTPUT -p tcp -j REDSOCKS
-A OUTPUT -p udp -j REDSOCKS

# Whitelist LANs and some other reserved addresses.
# https://en.wikipedia.org/wiki/Reserved_IP_addresses#Reserved_IPv4_addresses
-A REDSOCKS -d 0.0.0.0/8 -j RETURN
-A REDSOCKS -d 10.0.0.0/8 -j RETURN
-A REDSOCKS -d 127.0.0.0/8 -j RETURN
-A REDSOCKS -d 169.254.0.0/16 -j RETURN
-A REDSOCKS -d 172.16.0.0/12 -j RETURN
-A REDSOCKS -d 192.168.0.0/16 -j RETURN
-A REDSOCKS -d 224.0.0.0/4 -j RETURN
-A REDSOCKS -d 240.0.0.0/4 -j RETURN

# Whitelist remote server
-A REDSOCKS -d 159.203.93.54 -j RETURN
-A REDSOCKS -d 8.8.8.8 -j RETURN
-A REDSOCKS -d 9.9.9.9 -j RETURN

# Whitelist local ip
-A REDSOCKS -d 47.107.33.216 -j RETURN
-A REDSOCKS -d 114.216.209.160 -j RETURN
-A REDSOCKS -d 115.192.100.111 -j RETURN
-A REDSOCKS -d 121.14.45.20 -j RETURN
-A REDSOCKS -d 121.228.196.98 -j RETURN
-A REDSOCKS -d 124.221.185.210 -j RETURN
-A REDSOCKS -d 149.28.46.74 -j RETURN
-A REDSOCKS -d 218.76.79.0/4 -j RETURN
-A REDSOCKS -d 220.181.0.0/8 -j RETURN
-A REDSOCKS -d 221.219.176.38 -j RETURN
-A REDSOCKS -d 23.50.124.114 -j RETURN
-A REDSOCKS -d 140.82.9.156 -j RETURN

# Redirect everything else to redsocks port
-A REDSOCKS -p tcp -j REDIRECT --to-ports 31338
-A REDSOCKS -p udp -j REDIRECT --to-ports 10053

COMMIT
